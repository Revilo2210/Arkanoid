<!DOCTYPE html>
<html>

<head>
    <title>Move Paddle</title>
    <meta charset="utf-8" />

    <link rel="stylesheet" type="text/css" href="Style.css">

    <script>
//Variablen
        //Feld
        var gameCanvas;
        var gameCtx;

        var scoreCanvas;
        var scoreCtx;


        //Paddle
        var paddleX = 300;
        var paddleY;
        var paddleBreite = 100;
        var paddleHoehe = 20;
        var paddleMove = 20;

        //Ball
        var ballX;
        var ballY;
        var radius = 10;
        var ballColor = "green";        

        //Bewegung
        var moveX;
        var moveY;
        var start = true;

        //Booleans
        var ballDown = false;
        var leerpress = false;
        var pause = false;
        var canvasVisible = true;
        var inMainMenu = true;

        //Gamevars
        var lives = 3;
        var level = 1;

        var score = 0;

        var mouseX;
        var interval;
        var bricks = [];
        var brickHeight = 20;
        var brickWidth = 695 / 12;
        var brickDist = 5;
        var brickStartX = 50;
        var BrickStartY = 50;

        var gradient;

        //Sound
        var SoundBlockExplode = new Audio("sounds/explosion.wav"); // buffers automatically when created
        var SoundBlockMetalHard = new Audio("sounds/Metal_Hard.wav");
        var SoundBlock = new Audio("sounds/sf02.wav");
        var SoundBlockMetalSoft = new Audio("sounds/Metal_Soft.wav");
        var SoundBallDown = new Audio("sounds/Sad_Trombone.wav");
        var SoundEnde = new Audio("sounds/werner_blamage.wav");
        var SoundBackground = new Audio("sounds/Background.wav");



//Klassen
        class Brick {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.hitsToGo = 1;
                this.powerUp = 0;
                this.color = "red";
                this.value = 5;
            }
        }

        class FastBrick {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.hitsToGo = 3;
                this.powerUp = 1;
                this.color="green";
                this.value = 20;
            }
        }

        class HardBrick {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.hitsToGo = 5;
                this.powerUp = 2;
                this.color = "blue";
                this.value = 50;
            }
        }

//Funktionen
        //Initieren
        function init() {

            SoundBackground.play();
            SoundBackground.volume = 0.4;

            gameCanvas = document.getElementById("gameCanvas");
            gameCtx = gameCanvas.getContext("2d");

            gradient = gameCtx.createLinearGradient(0, 0, gameCanvas.width, 0)
            gradient.addColorStop("0", "green");
            gradient.addColorStop("0.25", "magenta");
            gradient.addColorStop("0.5", "blue");
            gradient.addColorStop("0.75", "yellow");
            gradient.addColorStop("1.0", "red");

            placeScoreCanvas();

            showMainMenu();
        }

        function showMainMenu() {
            gameCanvas.style.background = "url('space.jpg')";
            scoreCanvas.style.visibility = "hidden";

            gameCtx.font = "50px Arial";
            gameCtx.fillStyle = "white";
            gameCtx.fillText("Arkanoid", 250, 80);
            gameCtx.fillText("Press Enter to Start", 250, 150);
            gameCtx.stroke();
        }

        function placeScoreCanvas() {
            scoreCanvas = document.getElementById("scoreCanvas");
            scoreCtx = scoreCanvas.getContext("2d");

            console.log(gameCanvas.width);
            scoreCanvas.style.left = `${gameCanvas.width + 20}px`;
            scoreCanvas.style.position = "absolute";

            scoreCanvas.style.border = "red 1px solid";
        }

        function initGame() {
            scoreCanvas.style.visibility = "visible";
            gameCanvas.style.border = "red 1px solid";
            
            paddleY = gameCanvas.height - paddleHoehe - 10;

            setBricks();

            startGame();
        }
        
        function startGame() {

            ballX = paddleX + (paddleBreite / 2);
            ballY = paddleY - (radius+1);
            moveX = 0;
            moveY = 0;

            ballDown = false;
            start = true;
            leerpress = false;

            interval = setInterval(draw, 1);

            mouseX = document.all ? event.offsetX : event.pageX;
        }

//Write
        //"Finish-Screen"
        function WriteFinish() {
            clearInterval(interval);
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            drawPaddle();
            if(lives == 0){
                gameCtx.font = "30px Arial";
                gameCtx.fillStyle = gradient;
                SoundEnde.play();
                SoundEnde.currentTime=0;
                gameCtx.fillText("Looser!!!", 250, 50);
                gameCtx.fillText("Press F5 to Reload", 250, 100);
                gameCtx.fillText("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa", 0, 150);
                gameCtx.stroke();
            } else{
                SoundBallDown.play();
                SoundBallDown.currentTime=0;
                gameCtx.font = "30px Arial";
                gameCtx.fillText("Ball Down", 250, 50);
                gameCtx.fillText("Leben: " + lives, 250, 100);
                gameCtx.fillText("N zum Neustarten", 250, 150);
                gameCtx.stroke();
            }
        }

        function WriteWin(){
            clearInterval(interval);
            gameCtx.font = "30px Arial";
            gameCtx.fillText("Feddich!", 250, 50);
            gameCtx.fillText("Press F5 to Reload", 250, 100);
            gameCtx.stroke();
        }

//Draw
        function draw() {
			
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            drawBricks();
            drawPaddle();
            moveBall();
            drawScore();
			
            if(SoundBackground.currentTime >= 74){
                SoundBackground.currentTime=0;
            }
        }

        function drawScore() {
            scoreCtx.clearRect(0, 0, scoreCanvas.width, scoreCanvas.height);
            
            scoreCtx.font = "30px Arial";

            //Score
            scoreCtx.fillText("Score:", 10, 30);
            scoreCtx.fillText(score, 10, 60);

            //Lives
            scoreCtx.fillText("Lives:", 10, 130);
            scoreCtx.fillText(lives, 10, 160);

            //Level
            scoreCtx.fillText("Level:", 10, 230);
            scoreCtx.fillText(level, 10, 260);

            scoreCtx.stroke();
        }

        function setBricks(){
            var posAnX = brickStartX;
            var posAnY = BrickStartY;
            switch(level){
                case 1:
                console.log("LEVEL 1");
                   while((posAnY + brickHeight) < (gameCanvas.height / 2)){
                       console.log("h " + posAnY);
                       while(posAnX + brickWidth + brickStartX <= gameCanvas.width){
                           switch(Math.floor(Math.random() * 6)){
                               case 1: bricks.push(new FastBrick(posAnX, posAnY)); break;
                               case 5: bricks.push(new HardBrick(posAnX, posAnY)); break;
                               case 2: break;
                               default: bricks.push(new Brick(posAnX, posAnY)); break;
                           }
                           posAnX += brickWidth + brickDist;
                       }
                       posAnX = brickStartX;
                       posAnY += brickHeight + brickDist;
                   }
                   console.log(bricks);
                   break;
                default:
                console.log("DEFAULT");
                    while(posAnY + brickHeight < gameCanvas.height / 2){
                        while(posAnX + brickWidth + brickStartX <= gameCanvas.width){
                            bricks.push(new Brick(posAnX, posAnY));
                            posAnX += brickWidth + brickDist;
                        }
                        posAnY += brickHeight + brickDist;
                    }
                    break; 
            }
        }

        function drawBricks() {
            bricks.forEach(brick => {
                gameCtx.fillStyle = brick.color;
                gameCtx.fillRect(brick.x, brick.y, brickWidth, brickHeight);
                gameCtx.stroke();
            });
        }

        function drawBall() {
            gameCtx.beginPath();
            gameCtx.arc(ballX, ballY, radius, 0, 2 * Math.PI);
            gameCtx.fillStyle = gradient[ballX];
            gameCtx.fill();
            gameCtx.stroke();
        }

        //Paddle zeichnen
        function drawPaddle() {
            gameCtx.fillStyle = "#FFFF00"; //CSS draus machen
            gameCtx.fillRect(paddleX, paddleY, paddleBreite, paddleHoehe);
        }

//Divers
        function collisionDetect(){

            if(!rectCollision(paddleX, paddleY, paddleBreite, paddleHoehe)){
                if (ballY > gameCanvas.height) {
                    ballDown = true;
                    lives-=1;
                    WriteFinish();
                } else {
                    if (ballX + radius >= gameCanvas.width || ballX - radius <= 0)
                        moveX *= (-1);
                    if (ballY <= 0 + radius)
                        moveY *= (-1);

                    if (ballY < (gameCanvas.height / 2) + brickHeight) {
                        for(var i = 0; i<bricks.length; i++) {
                            if (rectCollision(bricks[i].x, bricks[i].y, brickWidth, brickHeight)) {
                                playBrickSound(bricks[i].hitsToGo);
                                bricks[i].hitsToGo -=1;
                                if(bricks[i].hitsToGo<=0){
                                    
                                    score += bricks[i].value;
                                    
                                    ballColor = bricks[i].color;
                                    
                                    bricks.splice(i, 1);

                                    if(bricks.length==0){
                                        draw();
                                        WriteWin();
                                    }
                                }
                                break;
                            }
                        }
                    }
                } 
            } else {
                if(ballY + radius < paddleY + (paddleHoehe/2)){
                    ballY -= ballY + radius - paddleY - 0,5;
                } else {
                    ballY += (paddleHoehe/2) + 0,5;
                    ballDown = true;
                    lives-=1;
                    WriteFinish();
                }
            }
        }  

        function rectCollision(rectX, rectY, rectW, rectH){

            var kathetenL = Math.sqrt((radius*radius)/2);

            if(ballX >= rectX && ballX <= rectX + rectW &&                          //Ball trifft...
                ((ballY - radius <= rectY + rectH && ballY - radius > rectY)        //... von unten
                ||(ballY + radius <= rectY + rectH && ballY + radius > rectY))){    //... von oben
                    moveY *= -1;
                    return true;
            }
            if(ballY >= rectY && ballY <= rectY + rectH &&                          //Ball trifft...
                ((ballX - radius <= rectX + rectW && ballX - radius > rectX)            //... von 
                ||(ballX + radius < rectX + rectW && ballX + radius >= rectX))){         //... von
                    moveX *= -1;
                    return true;
            }
            if(ballX + kathetenL >= rectX && ballX + kathetenL < rectX + rectW){        //Ball trifft linke...
                if(ballY - kathetenL <= rectY + rectH && ballY - kathetenL > rectY){    //... untere Ecke
                    if(moveX>0)
                        moveX *= -1;
                    if(moveY<0)
                        moveY *= -1;
                    return true
                }
                if(ballY + kathetenL < rectY + rectH && ballY + kathetenL >= rectY){    //... obere Ecke
                    if(moveX>0)
                        moveX *= -1;
                    if(moveY>0)
                        moveY *= -1;
                    
                    return true;
                }
                return false;    
            }
            if(ballX - kathetenL > rectX && ballX - kathetenL <= rectX + rectW){        //Ball trifft rechte...  
                if(ballY - kathetenL <= rectY + rectH && ballY - kathetenL > rectY){    //... untere Ecke
                    if(moveX<0)
                        moveX *= -1;
                    if(moveY<0)
                        moveY *= -1;
                    return true;
                }
                if(ballY + kathetenL < rectY + rectH && ballY + kathetenL >= rectY){    //... obere Ecke
                    if(moveX<0)
                        moveX *= -1;
                    if(moveY>0)
                        moveY *= -1;
                    return true;
                }    
            }
            return false;
        }

        function playBrickSound(hTG){
            switch(hTG){
                case 1:
                    SoundBlock.play();
                    SoundBlock.currentTime=0;
                    break;
                case 2: case 3:
                    SoundBlockMetalSoft.play();
                    SoundBlockMetalSoft.currentTime=0;
                    break;
                default:
                    SoundBlockMetalHard.play();
                    SoundBlockMetalHard.currentTime=0;
                    break;
            }
        }

        //Paddle soll Maus folgen?
        function show_position(event) {
            mouseX = document.all ? event.offsetX : event.pageX;

            if (mouseX <= 50) {
                paddleX = 0;
                if (leerpress == false) {
                    ballX = paddleX + 50;
                }
            }
            else if (mouseX >= 750) {
                paddleX = 700;
                if (leerpress == false) {
                    ballX = paddleX + 50;
                }
            }
            else {
                if (leerpress == false) {
                    ballX = mouseX;
                }
                paddleX = mouseX - 50;
            }
        }

        //Ball bewegen
        function moveBall() {
            
            collisionDetect();
            ballX += moveX;
            ballY += moveY;
            drawBall();
        }

        //Verwaltet Tastendruck
        function Tastenhandler(ev) {
            var key_press = String.fromCharCode(ev.keyCode);
            var key_code = ev.keyCode;

            if(inMainMenu) {
                if(key_code == 13){
                        inMainMenu = false;
                        initGame();
                }
            } 
            else {
                switch (key_press){                   
                    case "D":
                        if ((paddleX + paddleBreite) < gameCanvas.width) {
                            paddleX += paddleMove;
                            if (moveX == 0 && moveY == 0)
                                ballX += paddleMove;
                        }
                        break;
                    case "A":
                        if (paddleX >= 10) {
                            paddleX -= paddleMove;
                            if (moveX == 0 && moveY == 0)
                                ballX -= paddleMove;
                        }
                        break;
                    case "N":
                        if (ballDown == true) {
						    pause = false;
                            startGame();
                        }
                        break;
                    case "F":
                        moveX *= 2;
                        moveY *= 2;
                        paddleMove *= 2;
                        break;
                    case "G":
                        moveX /= 2;
                        moveY /= 2;
                        paddleMove /= 2;
                        break;
				    case "P":
                        if(pause == false && ballDown == false){
                            gameCtx.font = "60px Arial";
                            gameCtx.fillStyle = "white";
                            gameCtx.fillText("Pause", 300, 300);
                            pause = true;
                            clearInterval(interval);
                            SoundBackground.pause();
                        }
                        else if(pause ==  true && ballDown == false){
                            pause = false;
                            interval = setInterval(draw, 10);
                            SoundBackground.play();
                        }
                        break;
                    default:
                        if (key_code == 32 && start) {
                            leerpress = true;
                            moveX = 2.5;
                            moveY = (-2.5);
                            start = false;
                        }
                        break;
                    }
            }
        }

//Durchführung
        document.addEventListener("DOMContentLoaded", init, false);
        document.addEventListener("mousemove", show_position, false);
        document.addEventListener("keydown", Tastenhandler, false);
    </script>
</head>

<body>
    <element onmousemove="gameCanvas">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <canvas id="scoreCanvas" width="200" height="300"></canvas>
</body>

</html>