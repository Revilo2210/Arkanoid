<!DOCTYPE html>
<html>

<head>
    <title>Move Paddle</title>
    <meta charset="utf-8" />

    <link rel="stylesheet" type="text/css" href="Style.css">

    <script>
//Variablen
        //Feld
        var gameCanvas;
        var gameCtx;
        var scoreCanvas;
        var scoreCtx;


        //Paddle
        var paddleX = 300;
        var paddleY;
        var paddleWidth = 100;
        var paddleHeight = 20;
        var paddleMove = 20;

        //Ball
        var ballX;
        var ballY;
        var radius = 10;
        var ballColorGradient;

        //Bricks
        var bricks = [];
        var brickHeight = 20;
        var brickWidth = 695 / 12;
        var brickDist = 5;
        var brickStartX = 50;
        var BrickStartY = 50;

        var radiusPwUp = 5;
        var plusX = brickWidth/2;
        var plusY = brickHeight;
        var pwUpDiversity = 2; //range of PowerUp-Bricktypes minus "default"
        var movePwUp = 1;
        var powerUpQueue = [];
        var powerUpTimer = 10000;

        //Bewegung
        var moveX;
        var moveY;
        var interval;
        var intervalOverclocking = 5;
        var mouseX;

        //Booleans
        var start = true;
        var ballDown = false;
        var leerpress = false;
        var pause = false;
        var canvasVisible = true;
        var inMainMenu = true;
        var mute = false;
        var bot = false;

        //Gamevars
        var lives = 3;
        var level = 1;
        var score = 0;

        //Sound
        var vol = 1;
        var SoundBlockExplode = new Audio("sounds/explosion.wav"); // buffers automatically when created
        var SoundBlockMetalHard = new Audio("sounds/Metal_Hard.wav");
        var SoundBlock = new Audio("sounds/sf02.wav");
        var SoundBlockMetalSoft = new Audio("sounds/Metal_Soft.wav");
        var SoundBallDown = new Audio("sounds/Sad_Trombone.wav");
        var SoundEnde = new Audio("sounds/werner_blamage.wav");
        var SoundBackground = new Audio("sounds/Background.wav");
        var SoundWinning = new Audio("sounds/Win.wav");

//(Block-)Klassen
        class Brick {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.hitsToGo = 1;
                this.powerUp = 0;
                this.color = "red";
                this.value = 5;
            }
        }

        class FastBrick {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.hitsToGo = 3;
                this.powerUp = Math.floor(Math.random() * 2) + 1; // 1 or 2
                this.color="green";
                this.value = 20;
            }
        }

        class HardBrick {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.hitsToGo = 5;
                this.powerUp = Math.floor(Math.random() * 2) + 3; //3 or 4
                this.color = "blue";
                this.value = 50;
            }
        }

        class PowerUpBall {
            constructor(x, y, type){
                this.x = x;
                this.y = y;
                this.type = type;
                this.color = pickColor(type);
            }
        }

//Funktionen
    //Initieren
        function init() {

            SoundBackground.play();
            SoundBackground.volume = 0.4;

            gameCanvas = document.getElementById("gameCanvas");
            gameCtx = gameCanvas.getContext("2d");

            initBallColorGradient();

            placeScoreCanvas();

            showMainMenu();
        }

        function initGame() {
            scoreCanvas.style.visibility = "visible";
            gameCanvas.style.border = "red 1px solid";
            
            paddleY = gameCanvas.height - paddleHeight - 10;

            setBricks();

            startGame();
        }

        function initBallColorGradient(){
            ballColorGradient = gameCtx.createLinearGradient(0, 0, gameCanvas.width, 0)
            ballColorGradient.addColorStop("0", "yellow");
            ballColorGradient.addColorStop("0.25", "green");
            ballColorGradient.addColorStop("0.5", "blue");
            ballColorGradient.addColorStop("0.75", "magenta");
            ballColorGradient.addColorStop("1.0", "red");
        }


//Menus
    //Main-Menu
        function showMainMenu() {
            gameCanvas.style.background = "url('space.jpg')";
            scoreCanvas.style.visibility = "hidden";

            gameCtx.font = "50px Arial";
            gameCtx.fillStyle = "white";
            gameCtx.fillText("Arkanoid", 250, 80);
            gameCtx.fillText("Press Enter to Start", 250, 150);
            gameCtx.stroke();
        }
    //Score-Menu
        function placeScoreCanvas() {
            scoreCanvas = document.getElementById("scoreCanvas");
            scoreCtx = scoreCanvas.getContext("2d");

            scoreCanvas.style.left = `${gameCanvas.width + 20}px`;
            scoreCanvas.style.position = "absolute";
            scoreCanvas.style.border = "red 1px solid";
        }
        
        function startGame() {

            ballX = paddleX + (paddleWidth / 2);
            ballY = paddleY - (radius+1);
            moveX = 0;
            moveY = 0;

            ballDown = false;
            start = true;
            leerpress = false;

            interval = setInterval(draw, intervalOverclocking);

            //mouseX = document.all ? event.offsetX : event.pageX;
        }

//Event-Screens
    //"Fail-Screen"
        function WriteFinish() {
            clearInterval(interval);
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            drawPaddle();
            if(lives == 0){
                gameCtx.font = "30px Arial";
                gameCtx.fillStyle = ballColorGradient;
                SoundEnde.play();
                SoundEnde.currentTime=0;
                gameCtx.fillText("Looser!!!", 250, 50);
                gameCtx.fillText("Press F5 to Reload", 250, 100);
                gameCtx.fillText("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa", 0, 150);
                gameCtx.stroke();
            } else{
                SoundBallDown.play();
                SoundBallDown.currentTime=0;
                gameCtx.font = "30px Arial";
                gameCtx.fillText("Ball Down", 250, 50);
                gameCtx.fillText("Leben: " + lives, 250, 100);
                gameCtx.fillText("N zum Neustarten", 250, 150);
                gameCtx.stroke();
            }
        }
    //Win-Screen
        function WriteWin(){
            SoundWinning.play();
            SoundEnde.currentTime=0;
            clearInterval(interval);
            gameCtx.font = "30px Arial";
            gameCtx.fillStyle = "white";
            gameCtx.fillText("Feddich!", 250, 50);
            gameCtx.fillText("Press F5 to Reload", 250, 100);
            gameCtx.stroke();
        }

//Draw
    //draw Game
        function draw() {
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

            drawBricks();
            drawPowerUps();
            drawPaddle();
            moveBall();
            drawScore();
			
            if(SoundBackground.currentTime >= 74){
                SoundBackground.currentTime=0;
            }
        }

    //draw Score
        function drawScore() { //Muss nur neu wenn es sich Ã¤ndert
            scoreCtx.clearRect(0, 0, scoreCanvas.width, scoreCanvas.height);
            scoreCtx.font = "30px Arial";

            //Score
            scoreCtx.fillText("Score:", 10, 30);
            scoreCtx.fillText(score, 10, 60);

            //Lives
            scoreCtx.fillText("Lifes:", 10, 130);
            scoreCtx.fillText(lives, 10, 160);

            //Level
            scoreCtx.fillText("Level:", 10, 230);
            scoreCtx.fillText(level, 10, 260);

            //Speed
            var speed = Math.floor(Math.sqrt(moveX*moveX + moveY*moveY)*10)/10;
            scoreCtx.fillText("Speed:", 10, 330);
            scoreCtx.fillText(`${speed}px per ${intervalOverclocking}ms?`, 10, 360);

            //Mute
            scoreCtx.fillText("Sound:", 10, 430);
            if(mute == true){
                scoreCtx.fillText("off", 10, 460);
            } else {
                scoreCtx.fillText("on", 10, 460);
            }

            scoreCtx.stroke();
        }

    //draw Paddle
        function drawPaddle() {

            if (bot == true){
                paddleX = ballX-50;

                if (ballX <= 50) {
                    paddleX = 0;
                }
                else if (ballX >= 750) {
                    paddleX = 700;
                }
            }

            gameCtx.fillStyle = "#FFFF00";
            gameCtx.fillRect(paddleX, paddleY, paddleWidth, paddleHeight);
        }

    //draw Bricks from bricks-Array
        function drawBricks() {
            bricks.forEach(brick => {
                gameCtx.fillStyle = brick.color;
                gameCtx.fillRect(brick.x, brick.y, brickWidth, brickHeight);
                gameCtx.stroke();
            });
        }

    //support-method to initialize bricks-Array
        function setBricks(){
            var posAnX = brickStartX;
            var posAnY = BrickStartY;
            switch(level){
                case 1:
                   while((posAnY + brickHeight) < (gameCanvas.height / 2)){
                       while(posAnX + brickWidth + brickStartX <= gameCanvas.width){
                           switch(Math.floor(Math.random() * 6)){
                               case 1: bricks.push(new FastBrick(posAnX, posAnY)); break;
                               case 5: bricks.push(new HardBrick(posAnX, posAnY)); break;
                               case 2: break;
                               default: bricks.push(new Brick(posAnX, posAnY)); break;
                           }
                           posAnX += brickWidth + brickDist;
                       }
                       posAnX = brickStartX;
                       posAnY += brickHeight + brickDist;
                   }
                   break;
                default:
                    while(posAnY + brickHeight < gameCanvas.height / 2){
                        while(posAnX + brickWidth + brickStartX <= gameCanvas.width){
                            bricks.push(new Brick(posAnX, posAnY));
                            posAnX += brickWidth + brickDist;
                        }
                        posAnY += brickHeight + brickDist;
                    }
                    break; 
            }
        }

    //change Brick-Color, depending on hits left 
        function changeBrickColor(brickTC){
            switch(brickTC.hitsToGo){
                case 2:
                    brickTC.color = "red";
                    break;
                case 3: case 4:
                    brickTC.color = "green";
                    break; 
            }
        }

    //draw PowerUps
        function drawPowerUps(){
            for(var i = 0; i < powerUpQueue.length; i++) {
                gameCtx.beginPath();
                gameCtx.fillStyle = powerUpQueue[i].color;
                gameCtx.arc(powerUpQueue[i].x, powerUpQueue[i].y, radiusPwUp, 0, 2 * Math.PI);
                gameCtx.fill();
                gameCtx.stroke();
                powerPaddleCollisionhandler(i);
            }
        }

        function pickColor(type) {
            switch(type) {
                case 1: return "PaleGreen";
                case 2: return "Chartreuse";
                case 3: return "Chocolate";
                case 4: return "MistyRose";
                default: return "Fuchsia";
            }
        }

        function spawnPwUp(x, y, type){
            switch(type) {
                case 0: 
                    if(Math.floor(Math.random() * 10) == 0) {
                        powerUpQueue.push(new PowerUpBall(x, y, type));
                    } 
                    break;
                default:
                    powerUpQueue.push(new PowerUpBall(x, y, type));
                    break;
            }
        }

    //move (detect collisions and draw) Ball
        function moveBall() {
            collisionDetect();
            ballX += moveX;
            ballY += moveY;
            drawBall();
        }

    //draw Ball
        function drawBall() {
            gameCtx.beginPath();
            gameCtx.arc(ballX, ballY, radius, 0, 2 * Math.PI);
            gameCtx.fillStyle = ballColorGradient;
            gameCtx.fill();
            gameCtx.stroke();
        }

//Collision-Detection
    //complete check
        function collisionDetect(){

            if(!rectCollision(paddleX, paddleY, paddleWidth, paddleHeight)){
                if (ballY > gameCanvas.height) {
                    ballDown = true;
                    lives-=1;
                    WriteFinish();
                } else {
                    if (ballY < (gameCanvas.height / 2) + brickHeight) {
                        brickCollision();
                    }
                    if ((ballX + radius >= gameCanvas.width && moveX > 0) 
                    || (ballX - radius <= 0 && moveX < 0)){
                        moveX *= (-1);
                    }
                    if (ballY <= 0 + radius)
                        moveY *= (-1);

                } 
            } else {
                paddleCollision();
            }
        } 

    //support-method brick-collision logic
        function brickCollision(){
            for(var i = 0; i<bricks.length; i++) {
                if (rectCollision(bricks[i].x, bricks[i].y, brickWidth, brickHeight)) {
                    playBrickSound(bricks[i].hitsToGo);
                    changeBrickColor(bricks[i]);
                    bricks[i].hitsToGo -=1;
                    if(bricks[i].hitsToGo<=0){
                        score += bricks[i].value;
                        spawnPwUp(bricks[i].x + plusX, bricks[i].y + plusY, bricks[i].powerUp);
                        bricks.splice(i, 1);
                        if(bricks.length==0){
                            draw();
                            ballDown = true;
                            WriteWin();
                        }
                    }
                    break;
                }
            }
        }

    //support-method paddle-collision logic
        function paddleCollision(){
            if(ballY + radius < paddleY + (paddleHeight/2)){
                ballY -= ballY + radius - paddleY - 0,5;
            } else {
                ballY += (paddleHeight/2) + 0,5;
                ballDown = true;
                lives-=1;
                WriteFinish();
            }
        }

        function powerPaddleCollisionhandler(index){
            if(powerUpQueue[index].y + radiusPwUp >= paddleY 
                && powerUpQueue[index].y < paddleY + paddleHeight 
                && powerUpQueue[index].x + radiusPwUp/2 >= paddleX 
                && powerUpQueue[index].x - radiusPwUp/2 <= paddleX + paddleWidth){
                activatePwUp(powerUpQueue[index].type);
                powerUpQueue.splice(index, 1);
                console.log("aktiviert");
            } else {
                if(powerUpQueue[index].y < gameCanvas.height){
                    powerUpQueue[index].y += movePwUp;
                } else {
                    powerUpQueue.splice(index, 1);
                }
            }
        }

    //support-method rect-collision (paddle & bricks) check
        function rectCollision(rectX, rectY, rectW, rectH){

            var kathetenL = Math.sqrt((radius*radius)/2);

            if(ballX >= rectX && ballX <= rectX + rectW &&                          //Ball trifft...
                ((ballY - radius <= rectY + rectH && ballY - radius > rectY)        //... von unten
                ||(ballY + radius <= rectY + rectH && ballY + radius > rectY))){    //... von oben
                    moveY *= -1;
                    return true;
            }
            if(ballY >= rectY && ballY <= rectY + rectH &&                          //Ball trifft...
                ((ballX - radius <= rectX + rectW && ballX - radius > rectX)        //... von links 
                ||(ballX + radius < rectX + rectW && ballX + radius >= rectX))){    //... von rechts
                    moveX *= -1;
                    return true;
            }
            if(ballX + kathetenL >= rectX && ballX + kathetenL < rectX + rectW){        //Ball trifft linke...
                if(ballY - kathetenL <= rectY + rectH && ballY - kathetenL > rectY){    //... untere Ecke
                    if(moveX>0)
                        moveX *= -1;
                    if(moveY<0)
                        moveY *= -1;
                    return true;
                }
                if(ballY + kathetenL < rectY + rectH && ballY + kathetenL >= rectY){    //... obere Ecke
                    if(moveX>0)
                        moveX *= -1;
                    if(moveY>0)
                        moveY *= -1;
                    
                    return true;
                }
                return false;    
            }
            if(ballX - kathetenL > rectX && ballX - kathetenL <= rectX + rectW){        //Ball trifft rechte...  
                if(ballY - kathetenL <= rectY + rectH && ballY - kathetenL > rectY){    //... untere Ecke
                    if(moveX<0)
                        moveX *= -1;
                    if(moveY<0)
                        moveY *= -1;
                    return true;
                }
                if(ballY + kathetenL < rectY + rectH && ballY + kathetenL >= rectY){    //... obere Ecke
                    if(moveX<0)
                        moveX *= -1;
                    if(moveY>0)
                        moveY *= -1;
                    return true;
                }    
            }
            return false;
        }

//Sounds
        function playBrickSound(hTG){
            switch(hTG){
                case 1:
                    SoundBlock.play();
                    SoundBlock.currentTime=0;
                    break;
                case 2: case 3:
                    SoundBlockMetalSoft.play();
                    SoundBlockMetalSoft.currentTime=0;
                    break;
                default:
                    SoundBlockMetalHard.play();
                    SoundBlockMetalHard.currentTime=0;
                    break;
            }
        }

//Paddle follows mouse
        function show_position(event) {
            mouseX = document.all ? event.offsetX : event.pageX;

            if (mouseX <= 50) {
            paddleX = 0;
            if (leerpress == false) {
                ballX = paddleX + 50;
            }
            }
            else if (mouseX >= 750) {
                paddleX = 700;
                if (leerpress == false) {
                    ballX = paddleX + 50;
                }
            }
            else {
                if (leerpress == false) {
                    ballX = mouseX;
                }
                paddleX = mouseX - 50;
            } 
        }

        //paddle weite u position checken
        function activatePwUp(type){
            var change = 0;
            switch(type){
                case 0: lives++; break;
                case 1: 
                    moveX *= 2;
                    setTimeout(function(){moveX /= 2;}, powerUpTimer);
                    break;
                case 2: 
                    moveX /= 2;
                    setTimeout(function(){moveX *= 2;}, powerUpTimer);
                    break;
                case 3:
                    if(paddleWidth<=100){
                        paddleWidth += 50; 
                        if(paddleX > 25){ paddleX -= 25 };
                        setTimeout(function(){paddleWidth -= 30; paddleX += 15;}, powerUpTimer);
                    } break;
                case 4:
                    if(paddleWidth >= 100){
                        paddleWidth -= 50; 
                        if(paddleX + paddleWidth < gameCanvas.width - 25){ paddleX += 25 };
                        setTimeout(function(){paddleWidth += 30; paddleX -= 15;}, powerUpTimer);
                    }break;
                default: break;
            }
        }
  
        function soundHandler() {
            if(vol>0){
            vol=0;
            } else{ 
            vol = 1;
            }
            SoundBackground.volume = vol == 0 ? 0: 0.4;
            SoundBlockExplode.volume = vol;
            SoundBlockMetalHard.volume = vol;
            SoundBlock.volume = vol;     
            SoundBlockMetalSoft.volume = vol;               
            SoundBallDown.volume = vol;                 
            SoundEnde.volume = vol;
            SoundWinning.volume = vol;
        }
          
//key-handler
        function keyHandler(ev) {
            var key_code = ev.keyCode;
            
            if(key_code == 77){
                soundHandler();
            }
          
            if(inMainMenu) {
                if(key_code == 13){
                    inMainMenu = false;
                    initGame();
                }
            } else {
                switch (key_code){                
                    case 68: //D
                    case 39: //Right Arrow
                        if ((paddleX + paddleWidth) < gameCanvas.width) {
                            paddleX += paddleMove;
                            if (moveX == 0 && moveY == 0)
                                ballX += paddleMove;
                        }
                        break;
                    case 65: //A
                    case 37: //Left Arrow
                        if (paddleX >= 10) {
                            paddleX -= paddleMove;
                            if (moveX == 0 && moveY == 0)
                                ballX -= paddleMove;
                        }
                        break;
                    case 78: //N
                        if (ballDown == true && lives > 0) {
                            pause = false;
                            startGame();
                        }
                        break;
                    case 70: //F
                        moveX *= 2;
                        moveY *= 2;
                        paddleMove *= 2;
                        break;
                    case 71: //G
                        moveX /= 2;
                        moveY /= 2;
                        paddleMove /= 2;
                        break;
                    case 80: //P
                        if(pause == false && ballDown == false) {
                            gameCtx.font = "60px Arial";
                            gameCtx.fillStyle = "white";
                            gameCtx.fillText("Pause", 300, 300);
                            pause = true;
                            clearInterval(interval);
                            SoundBackground.pause();
                        } else {
                            if(pause ==  true && ballDown == false){
                                pause = false;
                                interval = setInterval(draw, intervalOverclocking);
                                SoundBackground.play();
                            }
                        }
                        break;
                    case 32: //Space
                        if (start) {
                            leerpress = true;
                            moveX = 2.5;
                            moveY = (-2.5);
                            start = false;
                        }
                        break;
                    case 66:
                      bot = !bot;
                      break;
                }
            }
        }

//Execution
        document.addEventListener("DOMContentLoaded", init, false);
        document.addEventListener("mousemove", show_position, false);
        document.addEventListener("keydown", keyHandler, false);
    </script>
</head>

<body>
    <element onmousemove="gameCanvas">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <canvas id="scoreCanvas" width="200" height="500"></canvas>
</body>

</html>